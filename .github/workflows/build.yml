name: Kernel Build

on: 
  pull_request:
    branches: [ master ]
  push:

jobs:
  build:
    name: Build
    runs-on: [ubuntu-latest]
    if: ${{ !contains(github.event.head_commit.message, 'skip ci') }}
    steps:
    - name: Clean Workspace
      run: rm -rf *.deb *.ddeb *.build *.buildinfo *.changes
    - name: Checkout Sources
      uses: actions/checkout@v3
      with:
          submodules: recursive
          path: pve-edge-kernel
    - name: Install kernel build deps
      run: sudo apt-get update && sudo apt-get install devscripts debhelper equivs asciidoc dwarves libdw-dev libelf-dev libiberty-dev libnuma-dev libslang2-dev quilt xmlto
    - name: Clean Repository
      run: git -C pve-edge-kernel submodule foreach git clean -ffdx
    - name: Build Kernel
      run: |
        rm -rf *.deb *.ddeb *.build *.buildinfo *.changes
        cd pve-edge-kernel
        debian/rules debian/control
        debuild -e CCACHE_DIR=/var/cache/ccache --prepend-path=/usr/lib/ccache --jobs=auto -b -uc -us
    - name: Upload Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: debs
        path: "*.deb"
